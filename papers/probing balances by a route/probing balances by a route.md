<!--
 * @Author: ZhXZhao
 * @Date: 2020-07-02 11:21:23
 * @LastEditors: ZhXZhao
 * @LastEditTime: 2020-07-02 15:21:52
 * @Description:
-->
# Probing Channel Balances in the Lightning Network

---


## 正文
在[On the Difficulty of Hiding the Balance](../asiaCCS2019-difficulty%20on%20hiding%20balance/On%20the%20Difficulty%20of%20Hiding%20the%20Balance.pdf)这篇文章中提出来的揭露通道余额的方法是攻击者与受害者建立通道，然后进行余额揭露攻击。

但在本篇文章中，攻击者是通过多跳节点连接到受害节点，即通过一个路由向受害者发送无效的交易，这样可以探寻到整个路径上的节点的通道余额。
具体过程为：
- 首先找到哪些通道是可以探测的，即通道两边的节点能够对请求做出响应，通道可以用作路由来转发交易。
- 对可用的通道进行余额揭露攻击（二分查找）。
- 对探测算法做优化，利用已知的通道余额的信息，当要发送的交易金额大于已知的通道余额时，将这些通道排除在外。

## 讨论对策

通过实验表明，通道余额并没有办法作为隐私数据来看待。但目前的闪电网络协议对于通道余额的管理，既没有用来优化路由的效率，也没有很好地保护余额隐私。所以接下来的讨论从两方面展开：1）优先考虑隐私；2）优先考虑路由效率。

### 不修改协议

作为节点路由政策的一部分实现。
当中间节点观测到来自同一个通道的大量失败路由交易并且交易金额符合二分查找的特点的时候，可以认为这是一个探测余额的攻击。

### 优先考虑隐私

为什么余额信息难以保护：
- 发送者知道支付是成功还是失败。
- 当支付失败时，发送者知道是哪个通道失败了。

#### 合并错误类型

不告诉发送者支付失败发生在哪个通道，将“未知的交易”和“资金不足”两种错误类型合并成一种错误类型来返回。但是这种方法有一个很明显的缺点：降低了支付的可靠性，发送方不知道哪个通道失败，在下一次路由的时候，不能将失败的路由排除在外。

#### 额外的循环

当前闪电网络的路由是由发送者选择的，并且交易会按照发送者给定的路由来进行转发，中间节点不能够改变路由节点的顺序。
现在修改这个协议，允许中间节点随机选择其他的节点再发往下一跳节点。比如A要通过B向D发送交易，A规定了路由为A->B->D，现在B可以自行添加一个节点C来转发交易，路由就变成了A->B->C->D，而A并不知晓。这样A就没办法确定路由的具体信息。
缺点是：需要大幅度地修改洋葱路由协议，并且使得交易费结构更为复杂。

#### JIT路由

Just In Time Routing.
在JIT路由中，当余额不足转发交易的时候，转发节点不会返回错误信息，而是中断路由，重新平衡通道中的余额，然后再转发交易。这样攻击者就不会了解到通道余额是不够的这个信息。

### 优先考虑路由效率

很多情况下，路由失败是因为发送者不知道路由中的余额信息，导致支付数额超过了余额。
文章中提出来一种方法：添加一个API，可以使得发送者来查询用于路由中的通道的余额，这样就可以消除掉因为通道余额不足而导致路由失败的情况，提升了路由的效率。
