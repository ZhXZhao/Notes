<!--
 * @Author: ZhXZhao
 * @Date: 2020-04-02 21:42:55
 * @LastEditors: ZhXZhao
 * @LastEditTime: 2020-06-03 20:41:42
 * @Description:
 -->

# On the Difficulty of Hiding the Balance of Lightning Network Channels


## 正文

本文的贡献：提出了一种方法来揭露闪电网络通道中的具体余额，并探讨了一下可能的应对方案。

## 介绍

在比特币闪电网络当中，为了能够在多跳节点之间进行路由，网络中的节点IP地址和通道容量都是公开的。但通道中每个节点拥有的具体余额是保密的。本文提出的攻击利用闪电网络客户端在错误发生时产生的具体错误信息，进而揭露通道中的具体余额。而且闪电网络中的洋葱路由还保障了被攻击者很难去追踪到攻击者。

## 攻击方案

假设A和B之间有一个通道AB，其容量为$C_{AB}$，攻击者M的目的是去揭露通道中A的余额$balance_{AB}$和B的余额$balance_{BA}$。
为执行攻击，M需要与A开启一个通道。一个天真的方案是：逐步增加M经由A支付到B的金额，直到支付错误的发生。那么最后一个正确执行的金额可以认为是A的余额$balance_{AB}$，然后通过$balance_{BA}=C_{AB}-balance_{AB}$得到B的余额。
但这样的攻击会耗费大量的财力，所以做出了改进。
M每次会经由A路由到B一个无效的支付：M会创建一个假的invoice和哈希值h(x)，假装是由B创建的，这个假的invoice只能被B识别而不能被A识别。*注意：要想使这个攻击成功，有一个条件是$balance_{MA} \geq balance_{AB}$*。这个攻击也可以扩展成M去揭露A与其他每一个节点间建立的通道中的双方余额。其条件仍是$balance_{MA} \geq balance_{AB_i}$。

### invoice

invoice包括支付金额、目的节点的公钥（即地址）、哈希值和来自收款人的invoice签名。

### 攻击实现

对于第一种情况的攻击的具体算法为：
- 输入为目的节点B，到达B节点的路由，支付的范围[minFlow, maxFlow]，即[0, $C_{AB}$]，和想要的确定的余额精度，返回为A的余额$balance_{AB}$。
- 最开始以支付范围的中间数作为路由的金额。且发送支付返回的信息一定为error。
  - 若发送支付返回的信息为“UnknownPaymentHash”，那么就意味着A可以承担起当前的金额，进而修改支付范围的下界为当前的支付金额。
  - 若发送支付返回的信息为“InsufficientFunds”，那么就意味着A不能够承担其当前的金额，进而修改支付范围的上界为当前的支付金额。
- 直到支付范围的上下界差值小于余额精度，算法终止，返回当前的金额作为$balance_{AB}$。

对于第二种情况的攻击的具体算法为：对A的每个邻居节点执行一遍算法1，返回一个A与其所有邻居通道中的余额的数组。

### 攻击开销

攻击开销主要分为两种：1）入场费（即，需要执行此攻击的本金）。2）消耗的资金。

#### 入场费

为了能够最大精度地执行余额揭露攻击，攻击者需要以通道的所允许的最大容量开启通道，现阶段为0.16777215 BTC，约为640.05美元（若串行的攻击）。如果并行的开启通道攻击，则需要的入场费为640.05*n 美元，这样可以减少攻击的时间。因此需要在攻击时间和入场费之间做一个权衡。

#### 消耗的资金

消耗的资金可分为三类：1）开启通道所产生的交易费。2）关闭通道所产生的交易费。和3）资金锁在通道中所产生的利息。
总计约0.00002 BTC，约为0.0763美元。

## 实验结果

分为在闪电网络主网和测试网上进行。
在闪电网络主网中只进行分析，而不进行真正的攻击，在闪电网络测试网中进行真正的攻击。

### 闪电网络主网

1, 732个节点和6, 501个通道。
在闪电网络的实现中，有两个主要限制，一个是单笔最大支付金额MAX_PAYMENT_ALLOWED，另一个是通道最大容量MAX_FUNDING_ALLOWED。只有$C_{AB} \leq$ MAX_PAYMENT_ALLOWED的通道才能够计算出准确的余额。
在主网中，89.10%的通道容量都是低于MAX_PAYMENT_ALLOWED。
还有一个有趣的度量是测试整个网络中所有通道的余额的开销。那么一个好的攻击策略就是去选择那些度高的节点进行连接来执行攻击。实验发现，通过连接141个高度节点即可实现对90%的通道的攻击。
对于时间开销来说，考虑算法1的迭代次数为：
$$ \log_2{(\lceil \frac{maxFlow-minFlow}{accuracy\_threshold} \rceil)} $$
减少迭代次数的方法：
- 减少maxFlow通过选择小容量的通道。
- 增大精度，允许更粗粒度的结果。

实验结果表明（忽略了MAX_PAYMENT_ALLOWED和MAX_FUNDING_ALLOWED的限制），对于精度为1聪的情况，24次迭代（60多秒）足以揭露准确余额。

### 闪电网络测试网

对于算法1来说，精度为0.0391美元，其平均执行时间为33.3秒，精度为1美元，其平均执行时间为10.25秒。
若攻击A所连接的所有的通道，10美元的精度可以在1分钟内攻击1432个节点（共1682个节点）。

## 应对策略

一种方法是有一定几率在返回错误信息时不返回具体的错误信息；另一种方法是通过某些方法来模糊通道中的具体余额。

### 拒绝支付请求

在支付出现错误的时候，有一定几率不返回具体的错误信息，若不返回具体的错误信息，算法1就无法得到具体的错误信息而无法进行决策，但也会影响正常节点的路由。因此需要在两者之间做一个权衡。
也可以通过一些方法来识别出余额揭露攻击的节点，进而拒绝返回具体错误信息：
- 如果A从B收到很多支付请求，而B只与A建立了通道，那么A可以认为B是异常的，所以增加拒绝返回具体错误信息的几率。
- 如果A收到来自B的支付金额符合算法1的模式，也增加拒绝返回具体错误信息的几率。

### 动态接受负余额

通过一些方法来掩盖通道中的具体余额，需要重构闪电网络的实现。

## 相关工作

在有关加密货币的文献和路由的文献中，有许多都研究了隐私和信息揭露方面的对抗性问题。

### 加密货币文献

4种攻击：1）区块链分析（将比特币地址和真实世界中个人身份连接起来）；2）网络监控（将比特币地址和IP地址连接起来）；3）攻击混币；4）余额揭露。

### 路由文献

也有类似于本文中的通过探测、收集元数据进行学习来实施类似黑洞攻击、吸血鬼攻击的路由攻击方式。

