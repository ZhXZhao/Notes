<!--
 * @Author: ZhXZhao
 * @Date: 2020-02-22 15:28:48
 * @LastEditors: ZhXZhao
 * @LastEditTime: 2021-03-11 11:03:39
 * @Description:
-->

# Merkle树和简单支付验证（SPV）

---



## Merkle树

**Merkle树**是一种哈希二叉树，它是一种用作快速归纳和校验大规模数据完整性的数据结构。

在比特币网络中，**Merkle树**被用来归纳一个区块中的所有交易，同时生成整个交易集合的数字指纹，且提供了一种校验区块是否存在某交易的高效途径。

在比特币中的merkle树，计算节点的哈希值采用的是**两次**SHA256哈希算法。

**构建merkle树过程**：自底向上构建。先计算交易的哈希值，作为树的叶子节点。然后将子节点的哈希值串联再做两次SHA256计算，作为父节点，一直递归到只有一个节点（即merkle树根）。

merkle树是二叉树，**需要偶数个叶子节点**，若仅有奇数个交易，则最后的交易会被复制一份来构成偶数个叶子节点。

## 简单支付验证（SPV）

Merkle树被SPV节点广泛使用。SPV节点仅保存区块头，通过merkle树路径来验证交易存在于区块。

例如，一个SPV节点想要知道即将到达他比特币钱包中某个地址的交易时，该节点会在节点间的通信连接上建立bloom过滤器，限制只接受含有目标地址的交易。当对等节点发现符合bloom过滤器的交易时，以merkleblock消息形式发送包含该交易的区块，merkleblock消息中只包含区块头和一条验证目标交易的merkle路径。SPV节点即可验证该区块中是否存在目标交易，SPV节点还会利用区块头来验证该区块是否在区块链中。
