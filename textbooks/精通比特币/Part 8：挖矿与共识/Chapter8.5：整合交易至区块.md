<!--
 * @Author: ZhXZhao
 * @Date: 2020-02-22 21:26:36
 * @LastEditors: ZhXZhao
 * @LastEditTime: 2020-02-22 22:15:17
 * @Description: 
 -->

# 整合交易至区块

---


- [整合交易至区块](#%e6%95%b4%e5%90%88%e4%ba%a4%e6%98%93%e8%87%b3%e5%8c%ba%e5%9d%97)
  - [交易块龄，矿工费和优先级](#%e4%ba%a4%e6%98%93%e5%9d%97%e9%be%84%e7%9f%bf%e5%b7%a5%e8%b4%b9%e5%92%8c%e4%bc%98%e5%85%88%e7%ba%a7)
  - [币基交易（coinbase）](#%e5%b8%81%e5%9f%ba%e4%ba%a4%e6%98%93coinbase)
  - [创币奖励与交易费](#%e5%88%9b%e5%b8%81%e5%a5%96%e5%8a%b1%e4%b8%8e%e4%ba%a4%e6%98%93%e8%b4%b9)
  - [币基交易的结构](#%e5%b8%81%e5%9f%ba%e4%ba%a4%e6%98%93%e7%9a%84%e7%bb%93%e6%9e%84)
  - [coinbase数据](#coinbase%e6%95%b0%e6%8d%ae)

验证交易后，比特币节点会将这些交易添加到自己的内存池中。内存池也称作交易池，用来暂存尚未被加入到区块的交易记录。

当一个挖矿节点与其他挖矿节点竞争挖矿时，也在收集交易记录并监听比特币网络，一旦接收到了新的区块，首先对新的区块进行验证，若验证成功则移除交易池中新区块中出现的交易，并立即构建一个新的候选区块并将交易池中的交易加入其中，开始下一个区块的挖矿竞争。

## 交易块龄，矿工费和优先级

挖矿节点会为交易池中的每笔交易分配一个优先级，选择较高优先级的交易来构建候选区块。交易的优先级是由交易输入所花费的UTXO的“块龄”决定，交易输入高，“块龄”大的优先级高。
交易的优先级是通过输入值和输入的“块龄”乘积之和除以交易的总长度得到的：
$$ Priority = Sum (Value \ of \ input * Input \ Age) / Transaction \ Size $$

交易输入值以“聪”为单位，UTXO的“块龄”为该UTXO在区块链中的深度，即UTXO从记录在区块链上开始到现在所经历过的区块数。交易大小由字节表示。

高优先级的值为大于57,600,000，先添加高优先级的交易，然后再按照“每千字节交易费”排序，填充区块。

## 币基交易（coinbase）

币基交易没有输入，不消耗UTXO，通常输出到挖矿者自己的比特币地址。

## 创币奖励与交易费

交易费为所有交易的输入值的和减去所有交易的输出值的和。币基交易中输出的比特币值也包含交易费。

## 币基交易的结构

币基交易与一般交易输入需要指定一个先前的UTXO不同，它包含一个“coinbase“输入。

coinbase输入结构：

| 大小                  | 字段         | 描述                                       |
| --------------------- | ------------ | ------------------------------------------ |
| 32个字节              | 交易         | 不引用任何一个交易，值全部为0       |
| 4个字节               | 输出索引     | 值全部为1            |
| 1-9个字节（可变整数） | coinbase数据长度 | coinbase数据长度             |
| 变长                  | coinbase数据     | 在v2版本的区块中，除了需要以区块高度开始外，其他数据可以任意填写，用于extra nonce和挖矿标签         |
| 4个字节               | 序列号       | 目前未被使用的交易替换功能，设成0xFFFFFFFF |

## coinbase数据

币基交易不包含解锁脚本字段，被coinbase数据替代。coinbase长度最小2字节，最大100字节。coinbase起始字节为区块高度，后面内容随意，由矿工决定。现在矿工使用coinbase实现extra nonce功能，并嵌入字符串来标识挖出这个区块的矿池。
