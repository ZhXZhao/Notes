<!--
 * @Author: ZhXZhao
 * @Date: 2020-02-21 22:38:04
 * @LastEditors: ZhXZhao
 * @LastEditTime: 2020-02-21 23:25:13
 * @Description: 
 -->

 # Bloom过滤器和存货更新

 ---


- [Bloom过滤器和存货更新](#bloom%e8%bf%87%e6%bb%a4%e5%99%a8%e5%92%8c%e5%ad%98%e8%b4%a7%e6%9b%b4%e6%96%b0)
  - [Bloom过滤器](#bloom%e8%bf%87%e6%bb%a4%e5%99%a8)
  - [存货更新](#%e5%ad%98%e8%b4%a7%e6%9b%b4%e6%96%b0)

## Bloom过滤器

Bloom过滤器是一个允许用户描述特定的关键词组合而不必精确表述的基于概率的过滤方法。它能让用户在有效搜索关键词的同时保护他们的隐私。在**SPV节点**里，这一方法被用来向对等节点发送交易信息查询请求，同时**交易地址不会被暴露**。

步骤：
1. 首先，SPV节点初始化一个空白的Bloom过滤器。
2. 接着，SPV节点为钱包中所包含的每个地址对应的交易输出创建相匹配的搜索模式。通常，这个搜索模式是P2PKH的锁定脚本，也可以是P2SH的锁定脚本。
3. 然后，SPV节点将每个搜索模式添加至Bloom过滤器中，这样只要关键词出现在交易中，就可以被过滤器识别。
4. 最后，对等节点用收到的Bloom过滤器来匹配交易并发送至SPV节点。

Bloom过滤器的实现原理：
通过一个可变长度（N）的二进制数组和可变数量（M）的一组哈希函数构成。这些哈希函数的输出值在1到N之间。

初始化时二进制数组中全为0，添加关键字时，首先依次计算M个哈希函数，并依次将计算结果对应位置的二进制数组置为1，若添加的关键字中有重复的位为1，则二进制数组中该位仍为1。当要验证某些关键字是否在Bloom过滤器中时，如果要验证的关键字经过M个哈希函数计算后的结果对应位置的二进制数组都为1，则只能说可能是（因为可能有重复），若有一个为0，则一定不是。

## 存货更新


SPV节点会建立一个只能和SPV节点钱包里的地址匹配的过滤器。SPV节点通过filterload消息使对等节点也建立一个同样的过滤器。对等节点会将每一个输出值带入到过滤器中验证，匹配的交易会返回给SPV节点。

当对等节点收到SPV节点的getdata消息时，会发出一条只含有和过滤器匹配的区块的区块头信息，以及与之匹配的交易merkle树，对等节点还会发出一条相匹配的交易的tx消息。

节点通过filteradd向Bloom过滤器添加关键词，通过filterclear清除过滤器，若需要删除Bloom过滤器中的某个关键词，只能先清除再添加。